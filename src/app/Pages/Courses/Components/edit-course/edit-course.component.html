<div class="overlay"></div>
<div class="ShowPopup">
  <div class="add-Course">
    <app-top-pop [NamePopup]="'Edit Course'" (isVisibleChange)="closePopup()"></app-top-pop>
    
    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoadingCourse">
      <div class="loading-content">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <p>Loading course data...</p>
      </div>
    </div>

    <form class="bodyCourse" [formGroup]="courseForm" *ngIf="isLoadTopic && !isLoadingCourse">
      <div class="leftCourse">
        <div class="couseContentAdd">
          <div class="titleCouser">
            <app-text-header [title]="'Main course informations'"></app-text-header>
            <div class="addData_course mt-4">
              <div class="courseDynamic d-flex gap-3 align-items-end mb-2">
                <div class="Course_name">
                  <label for="Course_name">Course name</label>
                  <input formControlName="name" type="text" class="input_Couser" id="Course_name"
                    placeholder="Enter course name">
                </div>
                <div class="deal-desc-btn" [class.active]="showDescription"
                  [pTooltip]=" !showDescription ? 'Add Description' : 'Hide Description'" tooltipPosition="top"
                  (click)="ShowDescription()">
                  <i class="fa-kit fa-subtitles"></i>
                </div>
              </div>

              <div class="desCourse_name Course_name mt-2 mb-3" [class.active]="!showDescription">
                <label for="Course_description">Course description</label>
                <textarea formControlName="description" class="input_Couser textarea_course"
                  id="Course_description"></textarea>
              </div>
            </div>
          </div>

          <div class="bottomCourse">
            <div class="leftBottom d-flex gap-3 align-items-center">
              <div class="topicCourseAdd">
                <label for="topicSelection">Topic *</label>
                <app-customslectwithicon [items]="topicsList" [selectedItem]="selectedTopic"
                  (selectionChange)="selectTopic($event)">
                </app-customslectwithicon>
              </div>

              <div class="stageCourseAdd">
                <label for="stageSelection">Stage *</label>
                <app-coustom-select-stage [items]="stages" [selectedItem]="selectedStage"
                  [disabled]="selectStageDisabled" (selectionChange)="selectStage($event)">
                </app-coustom-select-stage>
              </div>
            </div>

            <app-custom-select-price-or-free [coursePrice]="courseForm.get('price')?.value"
              (valueChange)="setSelectedPrice($event)">
            </app-custom-select-price-or-free>
          </div>

          <div class="priceCourseAdd">
            <div class="price_Course Course_name" *ngIf="!courseFree">
              <label for="Course_price">Course price *</label>
              <input formControlName="price" type="number" class="input_Couser" id="Course_price"
                placeholder="Enter course price">
            </div>
          </div>
        </div>

        <div class="couseImagesAdd">
          <div class="titleCouser">
            <app-text-header [title]="'Course image & video'"></app-text-header>
          </div>

          <div class="uploudImages">
            <div class="Course_image">
              <label for="Course_image">Course image</label>
              <div class="boxImage">
                <input #fileInput type="file" (change)="onFileSelected($event, 'image')" style="display: none"
                  accept="image/*">

                <div class="UploadImage d-flex align-items-center justify-content-center" *ngIf="!uploadedPhotoResponse && !courseForm.value.image"
                  (click)="triggerFileInput('image')">
                  <div class="iconImage">
                    <i class="fa-light fa-cloud-arrow-up"></i>
                    <p>Upload image</p>
                  </div>
                </div>

                <div class="imagePreview" *ngIf="uploadedPhotoResponse || courseForm.value.image">
                  <img [src]="uploadedPhotoResponse ? baseUrl + uploadedPhotoResponse.url : baseUrl + courseForm.value.image" alt="Course image">
                  <button type="button" class="deleteImage" (click)="deleteUploadedImage()">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>
              </div>
            </div>

            <div class="Course_video">
              <label for="Course_video">Course intro video</label>
              <div class="boxImage">
                <input #videoInput type="file" (change)="onFileSelected($event, 'video')" style="display: none"
                  accept="video/*">

                <div class="UploadImage d-flex align-items-center justify-content-center" *ngIf="!uploadedVideoResponse && !courseForm.value.video"
                  (click)="triggerFileInput('video')">
                  <div class="iconImage">
                    <i class="fa-light fa-cloud-arrow-up"></i>
                    <p>Upload video</p>
                  </div>
                </div>

                <div class="videoPreview" *ngIf="uploadedVideoResponse || courseForm.value.video">
                  <video [src]="uploadedVideoResponse ? baseUrl + uploadedVideoResponse.url : baseUrl + courseForm.value.video" controls></video>
                  <button type="button" class="deleteVideo" (click)="deleteUploadedVideo()">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="rightCourse">
        <div class="tagsContent">
          <app-text-header [title]="'Tags'"></app-text-header>
          <div class="tags mt-3">
            <p-multiSelect [(ngModel)]="selectedTags" [options]="tags" optionLabel="name"
              placeholder="Select tags" [ngModelOptions]="{standalone: true}">
            </p-multiSelect>
          </div>
        </div>

        <div class="filesContent mt-3">
          <app-text-header [title]="'Course files'"></app-text-header>
          <div class="files mt-3">
            <input #filesInput type="file" multiple (change)="onFileSelected($event, 'files')" style="display: none">
            <button type="button" class="uploadFilesBtn" (click)="triggerFileInput('files')">
              <i class="fa-solid fa-file-arrow-up"></i>
              Upload files
            </button>
            <div class="uploadedFiles" *ngIf="uploadedFilesResponse.length > 0">
              <p>{{ uploadedFilesResponse.length }} files uploaded</p>
            </div>
          </div>
        </div>

        <div class="customFieldsContent mt-3">
          <app-text-header [title]="'Custom fields'"></app-text-header>
          <div class="customFields mt-3">
            <div formArrayName="customFields">
              <div *ngFor="let field of customFieldsArray.controls; let i = index" [formGroupName]="i"
                class="custom-field-item">
                <input type="text" formControlName="key" placeholder="Field name" class="field-key">
                <input type="text" formControlName="value" placeholder="Field value" class="field-value">
                <button type="button" (click)="removeCustomField(i)" class="remove-field">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>
            <button type="button" (click)="addCustomField()" class="add-field-btn">
              <i class="fa-solid fa-plus"></i>
              Add custom field
            </button>
          </div>
        </div>

        <div class="discountContent mt-3" *ngIf="!courseFree">
          <app-text-header [title]="'Discount'"></app-text-header>
          <div class="discount mt-3" formGroupName="discount">
            <select formControlName="type" class="discount-type">
              <option value="0">Fixed amount</option>
              <option value="1">Percentage</option>
            </select>
            <input type="number" formControlName="amount" placeholder="Discount amount" class="discount-amount">
          </div>
        </div>
      </div>
    </form>

    <div class="footerCourse">
      <div class="btnsCourse">
        <button class="btn btnCansle" (click)="closePopup()">Cancel</button>
        <button class="btn btnUpdate" (click)="updateCourse()" [disabled]="isLoad">
          <ng-container *ngIf="!isLoad; else loading">
            Update Course
          </ng-container>
          <ng-template #loading>
            <i class="fa-solid fa-spinner fa-spin"></i> Updating...
          </ng-template>
        </button>
      </div>
    </div>
  </div>
</div> 