<div class="viewLesson mt-2" *ngIf="!isLoading">
  <div class="cover">
    <img
      src="Images/CardProfile.png"
      alt="Cover Image"
      width="100%"
      height="100%"
    />
    <div class="informainon d-flex justify-content-between">
      <div class="IconBack position-absolute">
        <a
          class="d-flex align-items-center gap-2 text-white"
          (click)="goBackToCourse()"
          style="cursor: pointer"
        >
          <i class="fa-solid fa-arrow-left"></i>
          <p>Back Course</p>
        </a>
      </div>
      <div class="rightInfo">
        <h2>{{ lessonDetail?.name || 'Lesson Title' }}</h2>
        <div class="tagsShow">
          <p class="tag" *ngFor="let tag of getTags()">#{{ tag.name }}</p>
        </div>
      </div>
      <div class="leftInfo">
        <img
          src="Images/create-videos-online-courses-cover-coursifyme.jpg"
          alt=""
        />
      </div>
    </div>
  </div>
  <div class="headerCover mt-2">
    <div class="tabs">
      <p-button
        (onClick)="value = 0"
        class="tab tab-active"
        [class.activeHeader]="value == 0"
        styleClass="tabHeader"
      >
        <div class="tab-icon">
          <i class="fa-brands fa-wpexplorer"></i>
        </div>
        <p>Overview</p>
      </p-button>
      <p-button
        (onClick)="value = 1"
        class="tab tab-active"
        [class.activeHeader]="value == 1"
        styleClass="tabHeader"
      >
        <div class="tab-icon">
          <i class="fa-kit fa-stream-icon-cp"></i>
        </div>
        <p>Videos</p>
      </p-button>
    </div>
  </div>
  <div class="ContentCourse mb-4 d-flex gap-3 align-items-start">
    <div class="leftContent">
      <p-tabs [value]="value">
        <p-tabpanels>
          <p-tabpanel [value]="0">
            <div class="course-info">
              <h2 class="section-title">About This Lesson</h2>
              <p class="description">
                {{ lessonDetail?.description || 'No description available' }}
              </p>

              <div class="course-header">
                <div class="icon"><span>&lt;/&gt;</span></div>
                <h3 class="course-title">
                  {{ lessonDetail?.name || 'Lesson Title' }}
                </h3>
              </div>

              <div class="course-stats">
                <div class="stat-card">
                  <div class="icon">
                    <i class="fas fa-video stat-icon"></i>
                  </div>
                  <div class="data">
                    <h4 class="stat-number">{{ getVideoStats().total }}</h4>
                    <p class="stat-label">Video Lessons</p>
                  </div>
                </div>

                <div class="stat-card">
                  <div class="icon">
                    <i class="fas fa-gift stat-icon"></i>
                  </div>
                  <div class="data">
                    <h4 class="stat-number">{{ getVideoStats().free }}</h4>
                    <p class="stat-label">Free Videos</p>
                  </div>
                </div>

                <div class="stat-card">
                  <div class="icon">
                    <i class="fas fa-lock stat-icon"></i>
                  </div>
                  <div class="data">
                    <h4 class="stat-number">{{ getVideoStats().premium }}</h4>
                    <p class="stat-label">Premium Videos</p>
                  </div>
                </div>

                <div class="stat-card">
                  <div class="icon">
                    <i class="fas fa-hashtag stat-icon"></i>
                  </div>
                  <div class="data">
                    <h4 class="stat-number">{{ getTags().length }}</h4>
                    <p class="stat-label">Tags</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="course-introVideo mt-2" *ngIf="lessonDetail?.introductionVideoUrl">
              <h2 class="section-title">Lesson Introduction Video</h2>
              <video
                #player
                controls
                crossorigin
                playsinline
                poster="https://fiverr-res.cloudinary.com/images/t_main1,q_auto,f_auto,q_auto,f_auto/gigs/311843542/original/8c9c677c05b80b431b4f10624d089f5c0c5c2732/do-the-best-poster-design.png"
              >
                <source
                  [src]="lessonDetail?.introductionVideoUrl"
                  type="video/mp4"
                />
              </video>
            </div>
          </p-tabpanel>
          <p-tabpanel [value]="1">
            <div class="accordion-container">
              <div
                class="accordion-item"
                *ngFor="let video of lessonDetail?.videos; let i = index"
              >
                <div class="accordion-header" (click)="toggle(i); onVideoClick(video.id)">
                  <div class="index-circle">{{ i + 1 }}</div>
                  <div class="video-title">{{ video.name }}</div>
                  <div class="video-url-debug" style="font-size: 10px; color: #888; word-break: break-all;" *ngIf="getVideoUrl(video.id)">
                    Dynamic URL: {{ getVideoUrl(video.id) }}
                  </div>
                  <div class="video-info">
                    <span class="duration">{{ getVideoDuration(video.durationInSeconds) }}</span>
                    <span class="status" [ngClass]="{ free: video.free, premium: !video.free }">
                      {{ getVideoStatus(video) }}
                    </span>
                  </div>
                  <i
                    class="fa-solid"
                    [ngClass]="{
                      'fa-chevron-up': openedIndex === i,
                      'fa-chevron-down': openedIndex !== i
                    }"
                  ></i>
                </div>

                <div class="accordion-content" *ngIf="openedIndex === i">
                  <div class="video-wrapper">
                    <!-- Loading state for video -->
                    <div *ngIf="isVideoLoading(video.id)" class="video-loading">
                      <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Loading video...</p>
                      </div>
                    </div>

                    <!-- Video player -->
                    <video
                      *ngIf="getVideoUrl(video.id) && !isVideoLoading(video.id)"
                      controls
                      crossorigin
                      playsinline
                      poster="https://fiverr-res.cloudinary.com/images/t_main1,q_auto,f_auto,q_auto,f_auto/gigs/311843542/original/8c9c677c05b80b431b4f10624d089f5c0c5c2732/do-the-best-poster-design.png"
                    >
                      <source
                        [src]="getVideoUrl(video.id)"
                        type="video/mp4"
                      />
                    </video>

                    <!-- Error state -->
                    <div *ngIf="!getVideoUrl(video.id) && !isVideoLoading(video.id)" class="video-error">
                      <div class="error-message">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                        <p>Failed to load video</p>
                        <button class="btn btn-sm btn-primary" (click)="loadVideoUrl(video.id)">
                          Retry
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </div>
    <div class="rightContent mt-2">
      <div class="box">
        <h4>Lesson Videos</h4>
        <ul class="videos">
          <li *ngFor="let video of lessonDetail?.videos" [class.locked]="isVideoLocked(video)">
            <p>
              <i class="fa-solid mx-1" [ngClass]="video.free ? 'fa-circle-check' : 'fa-lock'"></i>
              {{ video.name }}
            </p>
            <div class="video-meta">
              <span class="duration">{{ getVideoDuration(video.durationInSeconds) }}</span>
              <span
                class="tag"
                [ngClass]="{ free: video.free, premium: !video.free }"
              >
                {{ getVideoStatus(video) }}
              </span>
            </div>
          </li>
        </ul>
      </div>

      <div class="box tags" *ngIf="hasTags()">
        <h5>Lesson Tags</h5>
        <div class="tags-list">
          <span class="tag-item" *ngFor="let tag of getTags()">
            #{{ tag.name }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container d-flex justify-content-center align-items-center" *ngIf="isLoading" style="height: 400px;">
  <div class="text-center">
    <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
    <p>Loading lesson details...</p>
  </div>
</div>

<!-- Error State -->
<div class="error-container d-flex justify-content-center align-items-center" *ngIf="!isLoading && !lessonDetail" style="height: 400px;">
  <div class="text-center">
    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
    <p>Failed to load lesson details. Please try again.</p>
    <button class="btn btn-primary" (click)="loadLessonDetail()">Retry</button>
  </div>
</div>
