<div class="course-view-container" *ngIf="courseResponse as data">
  <!-- Course Header Section -->
  <div class="course-header-card">
    <div class="course-main-info">
      <div class="course-image-container">
        <img class="course-image" 
             [src]="data.result.photoUrl ? (baseUrlFile + data.result.photoUrl) : '/assets/Images/Course/Image+Background.png'" 
             alt="Course Image" />
        <div class="course-badge" *ngIf="data.result.free" class="free-badge">
          <i class="fas fa-gift"></i>
          <span>مجاني</span>
        </div>
        <div class="course-badge price-badge" *ngIf="!data.result.free">
          <i class="fas fa-tag"></i>
          <span>{{ data.result.priceAfterDiscount || data.result.price }} جنيه</span>
        </div>
        <!-- Favorite Button -->
        <button class="favorite-btn" 
                [class.favorited]="isFavorited" 
                (click)="toggleFavorite()"
                pTooltip="إضافة للمفضلة">
          <i class="fas fa-heart"></i>
        </button>
      </div>

      <div class="course-details">
        <div class="course-title-section">
          <h1 class="course-title">{{ data.result.name }}</h1>
          <div class="progress-message" *ngIf="isEnrolled">
            <i class="fas fa-lightbulb"></i>
            <span>{{ getProgressMessage() }}</span>
          </div>
          <div class="course-meta">
            <span class="stage-info">
              <i class="fas fa-layer-group"></i>
              {{ data.result.stage?.name }}
            </span>
            <span class="instructor-info">
              <i class="fas fa-user-tie"></i>
              {{ data.result.creator?.name }}
            </span>
            <span class="rating-info" *ngIf="data.result.rating > 0">
              <i class="fas fa-star"></i>
              {{ data.result.rating.toFixed(1) }}
            </span>
          </div>
        </div>

        <div class="course-stats">
          <div class="stat-item">
            <i class="fas fa-play-circle"></i>
            <span>{{ data.result.lessonssCount }} دروس</span>
          </div>
          <div class="stat-item">
            <i class="fas fa-users"></i>
            <span>{{ data.result.studentsCount }} طالب</span>
          </div>
          <div class="stat-item" *ngIf="data.result.duration">
            <i class="fas fa-clock"></i>
            <span>{{ formatDuration(data.result.duration) }}</span>
          </div>
          <div class="stat-item">
            <i class="fas fa-calendar-alt"></i>
            <span>{{ data.result.createdOn | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Section (Only for enrolled students) -->
    <div class="progress-section" *ngIf="isEnrolled">
      <div class="progress-header">
        <h3>تقدمك في الكورس</h3>
        <div class="progress-actions">
          <button class="action-btn notes-btn" (click)="toggleNotes()" pTooltip="الملاحظات">
            <i class="fas fa-sticky-note"></i>
          </button>
          <button class="action-btn share-btn" (click)="shareProgress()" pTooltip="مشاركة التقدم">
            <i class="fas fa-share-alt"></i>
          </button>
          <button class="action-btn discussion-btn" (click)="goToDiscussion()" pTooltip="المناقشات">
            <i class="fas fa-comments"></i>
          </button>
        </div>
      </div>

      <div class="progress-content">
        <div class="progress-stats">
          <div class="progress-stat">
            <div class="stat-value" [style.color]="getProgressColor()">
              {{ studentProgress.overallProgress }}%
            </div>
            <div class="stat-label">التقدم الإجمالي</div>
          </div>
          <div class="progress-stat">
            <div class="stat-value" [style.color]="getGradeColor()">
              {{ studentProgress.currentGrade }}
            </div>
            <div class="stat-label">الدرجة الحالية</div>
          </div>
          <div class="progress-stat">
            <div class="stat-value">{{ studentProgress.completedLessons }}/{{ studentProgress.totalLessons }}</div>
            <div class="stat-label">الدروس المكتملة</div>
          </div>
          <div class="progress-stat">
            <div class="stat-value">{{ studentProgress.timeSpent }}</div>
            <div class="stat-label">الوقت المقضي</div>
          </div>
          <div class="progress-stat">
            <div class="stat-value" style="color: #f59e0b;">
              {{ studentProgress.streak }}
            </div>
            <div class="stat-label">{{ getStreakMessage() }}</div>
          </div>
        </div>

        <div class="progress-bar-container">
          <p-progressbar 
            [value]="studentProgress.overallProgress" 
            [style]="{'height': '12px', 'border-radius': '6px'}"
            [color]="getProgressColor()">
          </p-progressbar>
          <div class="progress-text">
            <span>متبقي تقريباً {{ studentProgress.estimatedTimeToComplete }}</span>
          </div>
        </div>

        <!-- Weekly Goals -->
        <div class="weekly-goals" *ngIf="studentProgress.weeklyGoal > 0">
          <h4><i class="fas fa-target"></i> الهدف الأسبوعي</h4>
          <div class="goal-progress">
            <div class="goal-bar">
              <div class="goal-fill" [style.width.%]="(studentProgress.weeklyCompleted / studentProgress.weeklyGoal) * 100"></div>
            </div>
            <span class="goal-text">{{ studentProgress.weeklyCompleted }}/{{ studentProgress.weeklyGoal }} دروس</span>
          </div>
        </div>

        <!-- Achievements -->
        <div class="achievements" *ngIf="studentProgress.achievements.length > 0">
          <h4><i class="fas fa-trophy"></i> الإنجازات</h4>
          <div class="achievement-badges">
            <span class="achievement-badge" *ngFor="let achievement of studentProgress.achievements">
              <i class="fas fa-medal"></i>
              {{ achievement }}
            </span>
          </div>
        </div>

        <div class="progress-actions-main">
          <button class="continue-btn" (click)="continueLearning()" *ngIf="!isCompleted">
            <i class="fas fa-play"></i>
            متابعة التعلم
          </button>
          <button class="completed-btn" *ngIf="isCompleted" disabled>
            <i class="fas fa-check-circle"></i>
            تم إكمال الكورس
          </button>
          <button class="certificate-btn" 
                  (click)="downloadCertificate()" 
                  [disabled]="!studentProgress.certificateEligible"
                  [pTooltip]="!studentProgress.certificateEligible ? 'يجب إكمال 80% من الكورس للحصول على الشهادة' : 'تحميل الشهادة'">
            <i class="fas fa-certificate"></i>
            تحميل الشهادة
          </button>
        </div>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="notes-section" *ngIf="showNotes && isEnrolled">
      <div class="notes-header">
        <h3><i class="fas fa-sticky-note"></i> ملاحظاتك</h3>
        <button class="close-notes-btn" (click)="toggleNotes()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="add-note">
        <textarea 
          [(ngModel)]="studentNotes" 
          placeholder="اكتب ملاحظة جديدة..."
          class="note-input"
          rows="3">
        </textarea>
        <button class="save-note-btn" (click)="saveNotes()" [disabled]="!studentNotes.trim()">
          <i class="fas fa-save"></i>
          حفظ الملاحظة
        </button>
      </div>

      <div class="saved-notes" *ngIf="savedNotes.length > 0">
        <h4>الملاحظات المحفوظة</h4>
        <div class="note-item" *ngFor="let note of savedNotes">
          <div class="note-content">
            <p>{{ note.content }}</p>
            <small class="note-date">{{ note.timestamp | date:'dd/MM/yyyy HH:mm' }}</small>
          </div>
          <button class="delete-note-btn" (click)="deleteNote(note.id)">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Enrollment Section (For non-enrolled students) -->
    <div class="enrollment-section" *ngIf="!isEnrolled">
      <div class="enrollment-content">
        <h3>ابدأ رحلتك التعليمية</h3>
        <p>انضم إلى {{ data.result.studentsCount }} طالب آخرين في هذا الكورس</p>
        <button class="enroll-btn" (click)="enrollInCourse()">
          <i class="fas fa-user-plus"></i>
          التسجيل في الكورس
        </button>
      </div>
    </div>
  </div>

  <!-- Tabs Section -->
  <div class="tabs-container">
    <div class="custom-tab-header">
      <button class="tab-btn" 
              [class.active]="activeTab === 0" 
              (click)="activeTab = 0">
        <i class="fas fa-info-circle"></i>
        نظرة عامة
      </button>
      <button class="tab-btn" 
              [class.active]="activeTab === 1" 
              (click)="activeTab = 1">
        <i class="fas fa-play-circle"></i>
        المحاضرات
      </button>
      <button class="tab-btn" 
              [class.active]="activeTab === 2" 
              (click)="activeTab = 2">
        <i class="fas fa-question-circle"></i>
        الاختبارات
      </button>
      <button class="tab-btn" 
              [class.active]="activeTab === 3" 
              (click)="activeTab = 3">
        <i class="fas fa-star"></i>
        التقييمات
      </button>
      <button class="tab-btn" 
              [class.active]="activeTab === 4" 
              (click)="activeTab = 4"
              *ngIf="isEnrolled">
        <i class="fas fa-chart-line"></i>
        التقدم التفصيلي
      </button>
    </div>

    <div class="tab-content">
      <!-- Overview Tab -->
      <div class="tab-panel" *ngIf="activeTab === 0">
        <div class="overview-content">
          <div class="description-section">
            <h3><i class="fas fa-align-left"></i> وصف الكورس</h3>
            <p class="course-description">{{ data.result.description || 'لا يوجد وصف متاح لهذا الكورس.' }}</p>
          </div>

          <div class="course-info-grid">
            <div class="info-card">
              <div class="info-header">
                <i class="fas fa-info-circle"></i>
                <h4>معلومات الكورس</h4>
              </div>
              <div class="info-content">
                <div class="info-item">
                  <span class="label">المرحلة:</span>
                  <span class="value">{{ data.result.stage?.name }}</span>
                </div>
                <div class="info-item">
                  <span class="label">المدرس:</span>
                  <span class="value">{{ data.result.creator?.name }}</span>
                </div>
                <div class="info-item">
                  <span class="label">عدد الدروس:</span>
                  <span class="value">{{ data.result.lessonssCount }}</span>
                </div>
                <div class="info-item">
                  <span class="label">عدد الطلاب:</span>
                  <span class="value">{{ data.result.studentsCount }}</span>
                </div>
                <div class="info-item" *ngIf="data.result.rating > 0">
                  <span class="label">التقييم:</span>
                  <span class="value">{{ data.result.rating.toFixed(1) }} نجوم</span>
                </div>
              </div>
            </div>

            <div class="info-card" *ngIf="isEnrolled">
              <div class="info-header">
                <i class="fas fa-calendar-check"></i>
                <h4>معلومات التسجيل</h4>
              </div>
              <div class="info-content">
                <div class="info-item">
                  <span class="label">تاريخ التسجيل:</span>
                  <span class="value">{{ formatDate(studentProgress.enrollmentDate) }}</span>
                </div>
                <div class="info-item">
                  <span class="label">آخر وصول:</span>
                  <span class="value">{{ formatDate(studentProgress.lastAccessed) }}</span>
                </div>
                <div class="info-item">
                  <span class="label">حالة الشهادة:</span>
                  <span class="value" [class.text-success]="studentProgress.certificateEligible" [class.text-warning]="!studentProgress.certificateEligible">
                    {{ studentProgress.certificateEligible ? 'مؤهل للحصول على الشهادة' : 'غير مؤهل بعد' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lessons Tab -->
      <div class="tab-panel" *ngIf="activeTab === 1">
        <app-lesson [courseId]="courseId"></app-lesson>
      </div>

      <!-- Quizzes Tab -->
      <div class="tab-panel" *ngIf="activeTab === 2">
        <app-all-quiz-view-course [courseId]="courseId"></app-all-quiz-view-course>
      </div>

      <!-- Ratings Tab -->
      <div class="tab-panel" *ngIf="activeTab === 3">
        <app-rating [courseId]="courseId"></app-rating>
      </div>

      <!-- Detailed Progress Tab -->
      <div class="tab-panel" *ngIf="activeTab === 4 && isEnrolled">
        <div class="detailed-progress">
          <h3><i class="fas fa-chart-line"></i> التقدم التفصيلي</h3>
          
          <div class="progress-cards">
            <div class="progress-card">
              <div class="card-header">
                <i class="fas fa-percentage"></i>
                <h4>نسبة الإنجاز</h4>
              </div>
              <div class="card-content">
                <div class="big-number" [style.color]="getProgressColor()">
                  {{ studentProgress.overallProgress }}%
                </div>
                <div class="card-chart">
                  <p-progressbar 
                    [value]="studentProgress.overallProgress" 
                    [style]="{'height': '8px', 'border-radius': '4px'}"
                    [color]="getProgressColor()">
                  </p-progressbar>
                </div>
              </div>
            </div>

            <div class="progress-card">
              <div class="card-header">
                <i class="fas fa-trophy"></i>
                <h4>متوسط الدرجات</h4>
              </div>
              <div class="card-content">
                <div class="big-number" [style.color]="getGradeColor()">
                  {{ studentProgress.averageScore }}
                </div>
                <div class="grade-indicator">
                  <span class="current-grade" [style.color]="getGradeColor()">
                    {{ studentProgress.currentGrade }}
                  </span>
                </div>
              </div>
            </div>

            <div class="progress-card">
              <div class="card-header">
                <i class="fas fa-fire"></i>
                <h4>الأيام المتتالية</h4>
              </div>
              <div class="card-content">
                <div class="big-number" style="color: #f59e0b;">
                  {{ studentProgress.streak }}
                </div>
                <div class="streak-message">
                  {{ getStreakMessage() }}
                </div>
              </div>
            </div>

            <div class="progress-card">
              <div class="card-header">
                <i class="fas fa-clock"></i>
                <h4>الوقت المقضي</h4>
              </div>
              <div class="card-content">
                <div class="big-number" style="color: #6366f1;">
                  {{ studentProgress.timeSpent }}
                </div>
                <div class="time-estimate">
                  متبقي: {{ studentProgress.estimatedTimeToComplete }}
                </div>
              </div>
            </div>
          </div>

          <!-- Learning Analytics -->
          <div class="learning-analytics">
            <h4><i class="fas fa-analytics"></i> تحليل الأداء</h4>
            <div class="analytics-grid">
              <div class="analytics-item">
                <span class="analytics-label">الدروس المكتملة:</span>
                <span class="analytics-value">{{ studentProgress.completedLessons }}/{{ studentProgress.totalLessons }}</span>
                <div class="analytics-bar">
                  <div class="analytics-fill" [style.width.%]="(studentProgress.completedLessons / studentProgress.totalLessons) * 100"></div>
                </div>
              </div>
              
              <div class="analytics-item">
                <span class="analytics-label">الهدف الأسبوعي:</span>
                <span class="analytics-value">{{ studentProgress.weeklyCompleted }}/{{ studentProgress.weeklyGoal }}</span>
                <div class="analytics-bar">
                  <div class="analytics-fill" [style.width.%]="(studentProgress.weeklyCompleted / studentProgress.weeklyGoal) * 100"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Progress Actions -->
          <div class="progress-actions-detailed">
            <button class="action-btn-detailed reset-btn" (click)="resetProgress()">
              <i class="fas fa-redo"></i>
              إعادة تعيين التقدم
            </button>
            <button class="action-btn-detailed export-btn" (click)="shareProgress()">
              <i class="fas fa-download"></i>
              تصدير التقرير
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="!courseResponse">
  <div class="loading-content">
    <i class="fas fa-spinner fa-spin"></i>
    <h3>جاري تحميل بيانات الكورس...</h3>
  </div>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="courseResponse === null">
  <div class="error-content">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>خطأ في تحميل البيانات</h3>
    <p>حدث خطأ أثناء تحميل بيانات الكورس. يرجى المحاولة مرة أخرى.</p>
    <button class="retry-btn" (click)="loadCourseData()">
      <i class="fas fa-retry"></i>
      إعادة المحاولة
    </button>
  </div>
</div> 